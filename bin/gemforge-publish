#!/bin/sh
set -euf
DIR=$(dirname $0)
. $DIR/gemforge

## Program Tracking ##

program_command="gemforge-publish"
program_version="5.0.2"
program_updated="2018-06-21"
program_license="GPL"
program_contact="Joel Parker Henderson (joel@joelparkerhenderson.com)"

## Help Function ##

help(){
cat << EOF
gemforge-publish

Publish our gem from our current directory
to a variety of destinations (remote, github, etc.)

This is intended for a directory with these kinds of files:

  * `foo.gemspec`  # gemspec file that sets the name, version, etc.
  * `coverage`     # autogenerated rcov files
  * `doc/`         # autogenerated rdoc files or yardoc files
  * `lib/foo/`     # class files
  * `lib/foo.rb`   # file that loads all the other files
  * `test/`        # test files

Example:

    cd mygem
    gemforge-publish
    => removes all version of this gem, e.g. rm mygem-1.2.3.gem
    => removes temp files, e.g. files ending in tilde, hash, etc.
    => builds the gem
    => rdoc with custom template
    => git add, commit, push
    => copy to railapp.com then remote gem generate

Tracking:

  * Command: $program_command
  * Version: $program_version
  * Updated: $program_updated
  * License: $program_license
  * Contact: $program_contact
EOF
}

## Preflight

cmd "gem"  || die "cmd gem"
cmd "ruby" || die "cmd ruby"
cmd "yard" || die "cmd yard"

### BUILD

gemforge-rm-old-files
gemforge-update-build
gemforge-update-version
gemforge-sha512     || die "gemforge-sha512 failed for gem $(gem_name_version)"
gemforge-update-doc || die "gemforge-update-doc failed for gem $(gem_name_version)"
gemforge-proof      || die "gemforge-proof failed for gem $(gem_name_version)"

### PUBLISH

#out 'PUBLISH GITHUB...' && gemforge-publish-to-github && out '...DONE'
#out 'PUBLISH TO LOCAL HOST...'  && gemforge-publish-to-local-host  && out '...DONE'
#out 'PUBLISH TO REMOTE HOST...' && gemforge-publish-to-remote-host && out '...DONE'
out 'PUBLISH TO RUBYDOC...' && gemforge-publish-to-rubydoc && out '...DONE'
out 'PUBLISH TO RUBYGEMS...' && gemforge-publish-to-rubygems && out '...DONE'
