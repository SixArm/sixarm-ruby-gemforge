#!/bin/bash
set -o errexit

##
# Do simple checking of our gem's files to ensure
# that everything looks good before we publish.
##

gem_name_version=`gemspec-cat | gemspec-to-gem-name-version`
gem_name=`gemspec-cat | gemspec-to-gem-name`
gem_version=`gemspec-cat | gemspec-to-gem-version`

function err ( ) {
   echo "gemforge-lint $gem_name_version $@" >&2
}


function file_line_should_eq {
  file=$1
  line_num=$2
  expect_line=$3
  actual_line=`sed -n "${line_num}p" "$file"`
  if [ "$expect_line" != "$actual_line" ]
  then
    err "file $file line $line_num\n expect: $expect_line\n actual:$actual_line"
  fi
}

function grepq {
  grep -q "$2" "$1" || err "$1 grep $2"
}

### Repair

# Repair via placeholders
[ -e "VERSION" ] || echo "$gem_version" > VERSION

# Repair via cookie cutter
for path in ".rspec" "Rakefile"
do
  [ -e "$path" ] || cp "/home/sixarm/git/sixarm_ruby_week/$path" .
done

# Repair via building
[ -e "coverage" ] || gemforge-test
[ -e "doc" ] || gemforge-create-doc
[ -e "$gem_name_version.gem" ] || gemforge-build-gemspec
[ -e "$gem_name_version-sha512.txt" ] || gemforge-sha512

# Repair versions
grep -q "^$gem_version$" VERSION || echo "$gem_version" > VERSION

# Fill in
gemforge-fill-in


###

for path in "CHANGELOG.txt" "INSTALL.txt" "LICENSE.txt" "$gem_name.sha512.txt"
do
  [ -e "$path" ] && err "$path should not exist"
done

ls -1 *.gem | wc -l | grep "^ *1$" > /dev/null || err "More than one gem"
ls -1 *sha512.txt | wc -l | grep "^ *1$" > /dev/null || err "More than one sha512"

for path in ".document" ".gemtest" ".git" ".rspec" "CONTRIBUTING.md" "Rakefile" "README.md" "VERSION" "coverage" "coverage/assets" "coverage/index.html" "doc" "lib" "lib/${gem_name}.rb" test "test/${gem_name}_test.rb" "$gem_name.gemspec" "$gem_name_version.gem" "$gem_name_version-sha512.txt"
do
  [ -e "$path" ] || err "-e $path"
done

file="$gem_name.gemspec"
file_line_should_eq "$file" 1 "# -*- coding: utf-8 -*-"
file_line_should_eq "$file" 2 ""
file_line_should_eq "$file" 3 "Gem::Specification.new do |s|"
for s in \
  "^  s.name           = \"sixarm_ruby_.*\"" \
  "^  s.summary        = \"SixArm.com » Ruby » .*\"" \
  "^  s.description    = \".*\"" \
  "^  s.version        = \".*\"" \
  "^  s.author         = \"SixArm\"" \
  "^  s.email          = \"sixarm@sixarm.com\"" \
  "^  s.homepage       = \"http://sixarm.com/\"" \
  "^  s.licenses       = \[.*\]" \
  "^  s.signing_key    = '.*/sixarm-rsa2048-x509-20140312-gem-private-key.pem'" \
  "^  s.cert_chain     = \['.*/sixarm-rsa2048-x509-20140312-gem-public-cert.pem'\]" \
  "^  s.platform       = Gem::Platform::RUBY" \
  "^  s.require_path   = 'lib'" \
  "^  s.has_rdoc       = true" \
  "^  top_files        = \[.*\".gemtest\", .*\"CONTRIBUTING.md\", .*\"Rakefile\", .*\"README.md\",.*\"VERSION\".*\]" \
  "^  lib_files        = \[\"lib/#{s.name}.rb\"" \
  "^  test_files       = \[\"test/#{s.name}_test.rb\"" \
  "^  s.files          = top_files + lib_files + test_files" \
  "^  s.test_files     = test_files"
do
  grepq "$file" "$s"
done

file="VERSION"
grep -q "^$gem_version$" $file || err "$file version is wrong"

file="README.md"
for s in \
  "^# SixArm.com » Ruby » <br> " \
  "^* Doc: <http://sixarm.com/$gem_name/doc>" \
  "^* Gem: <http://rubygems.org/gems/$gem_name>" \
  "^* Repo: <http://github.com/sixarm/$gem_name>" \
  "^* Email: Joel Parker Henderson, <joel@sixarm.com>" \
  "^## Introduction" \
  "^For docs go to <http://sixarm.com/$gem_name/doc>" \
  "^## Install quickstart" \
  "^    gem install $gem_name" \
  "^    gem \"$gem_name\", \"~>$gem_version\"" \
  "^    require \"$gem_name\"" \
  "^## Install with security (optional)" \
  "^    gem install $gem_name --test --trust-policy HighSecurity" \
  "^## License" \
  "^## Changes"
do
  grepq "$file" "$s"
done

#grep -q '^Author::\( Joel Parker Henderson, joel@joelparkerhenderson.com\| Found on the internet by Joel Parker Henderson, joel@joelparkerhenderson.com\)' $file || err "$file author is wrong"
#  "^\(Copyright (c) .*2013 Joel Parker Henderson\| Copyright the original author; please email me if you know who wrote this\)" \


file="lib/${gem_name}.rb"
file_line_should_eq "$file" 1 "# -*- coding: utf-8 -*-"
file_line_should_eq "$file" 2 "=begin rdoc"
file_line_should_eq "$file" 3 "Please see README"
file_line_should_eq "$file" 4 "=end"
file_line_should_eq "$file" 5 ""

file="test/${gem_name}_test.rb"
file_line_should_eq "$file" 1 "# -*- coding: utf-8 -*-"
file_line_should_eq "$file" 2 "require 'minitest/autorun'"
file_line_should_eq "$file" 3 "Minitest::Test ||= MiniTest::Unit::TestCase"
file_line_should_eq "$file" 4 "require 'simplecov'"
file_line_should_eq "$file" 5 "SimpleCov.start"

exit 0
