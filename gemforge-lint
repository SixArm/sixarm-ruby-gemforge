#!/bin/bash
set -o errexit

##
# Do simple checking of our gem's files to ensure
# that everything looks good before we publish.
##

gem_name=`gemspec-cat | gemspec-to-gem-name`
gem_name_version=`gemspec-cat | gemspec-to-gem-name-version`

function die ( ) {
   echo $@ >&2
   exit 1
}


function file_line_should_eq {
  file=$1
  line_num=$2
  expect_line=$3
  actual_line=`sed -n "${line_num}p" "$file"`
  if [ "$expect_line" != "$actual_line" ] 
  then
    die "file $file line $line_num\n expect: $expect_line\n actual:$actual_line"
  fi
}

for path in ".git" "INSTALL.txt" "LICENSE.txt" "README.rdoc" "coverage" "coverage/assets" "coverage/index.html" "coverage/resultset.yml" "doc" "lib" "lib/${gem_name}.rb" test "test/${gem_name}_test.rb" "$gem_name.gemspec" "$gem_name_version.gem" "$gem_name_version-sha512.txt"
do
  [ -e "$path" ] || die "gemforge-lint $gem_name_version error -e $path"
done

file="lib/${gem_name}.rb"
file_line_should_eq "$file" 1 "# -*- coding: utf-8 -*-"
file_line_should_eq "$file" 2 ""
file_line_should_eq "$file" 3 "=begin rdoc" 
file_line_should_eq "$file" 4 ""

file="test/${gem_name}_test.rb"
file_line_should_eq "$file" 1 "# -*- coding: utf-8 -*-" 
file_line_should_eq "$file" 2 "require 'test/unit'"

grep SimpleCov $file || die "SimpleCov is missing from: $file"
  
exit 0

