#!/bin/bash
set -o errexit

##
# Do simple checking of our gem's files to ensure
# that everything looks good before we publish.
##

gem_name_version=`gemspec-cat | gemspec-to-gem-name-version`
gem_name=`gemspec-cat | gemspec-to-gem-name`
gem_version=`gemspec-cat | gemspec-to-gem-version`

function die ( ) {
   echo $@ >&2
   exit 1
}


function file_line_should_eq {
  file=$1
  line_num=$2
  expect_line=$3
  actual_line=`sed -n "${line_num}p" "$file"`
  if [ "$expect_line" != "$actual_line" ] 
  then
    die "file $file line $line_num\n expect: $expect_line\n actual:$actual_line"
  fi
}

for path in ".document" ".git" ".gitignore" ".rspec" "CHANGELOG.txt" "INSTALL.txt" "LICENSE.txt" "README.rdoc" "VERSION" "coverage" "coverage/assets" "coverage/index.html" "coverage/resultset.yml" "doc" "lib" "lib/${gem_name}.rb" test "test/${gem_name}_test.rb" "$gem_name.gemspec" "$gem_name_version.gem" "$gem_name_version-sha512.txt"
do
  [ -e "$path" ] || die "gemforge-lint $gem_name_version error -e $path"
done

file="$gem_name.gemspec"
grep -q "top_files" $file || die "Need top_files in $file"
grep -q "\[.*\".gemtest\", .*\"CHANGELOG.txt\", .*\"INSTALL.txt\", .*\"LICENSE.txt\", .*\"Rakefile\", .*\"README.rdoc\",.*\"VERSION\".*\]" $file || die "Need top_files fixed in $file: [.*\".gemtest\", .*\"CHANGELOG.txt\", .*\"INSTALL.txt\", .*\"LICENSE.txt\", .*\"Rakefile\", .*\"README.rdoc\",.*\"VERSION\".*\]"

file="VERSION"
grep -q "^$gem_version$" $file || die "Version is wrong in file:$file"

file="README.rdoc"
grep -q "^Author:: Joel Parker Henderson, joel@joelparkerhenderson.com" $file || die "Author is wrong"
grep -q "^Copyright:: Copyright (c) .*2011 Joel Parker Henderson" $file || die "Copyright is wrong"
grep -q "^License:: See LICENSE.txt file" $file || die "License is wrong, should say: License:: See LICENSE.txt file"      
grep -q "^= SixArm.com » Ruby » " $file || die "Missing title: = SixArm.com » Ruby » "

file="lib/${gem_name}.rb"
file_line_should_eq "$file" 1 "# -*- coding: utf-8 -*-"
file_line_should_eq "$file" 2 "=begin rdoc" 
file_line_should_eq "$file" 3 "Please see README.rdoc"
file_line_should_eq "$file" 4 "=end"
file_line_should_eq "$file" 5 ""
                                            
file="test/${gem_name}_test.rb"
file_line_should_eq "$file" 1 "# -*- coding: utf-8 -*-" 
file_line_should_eq "$file" 2 "require 'test/unit'"
grep -q SimpleCov $file || die "SimpleCov is missing from: $file"


  
exit 0

